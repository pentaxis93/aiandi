---
/**
 * Theme Picker Component
 * 
 * Dropdown to select theme and toggle dark/light mode.
 * Persists theme and mode to localStorage.
 * 
 * Theme key format: "{themeId}-{mode}" e.g., "lab-dark", "lab-light"
 */
import { themes, defaultTheme, defaultMode } from '../themes';
---

<div class="theme-picker relative">
	<button 
		id="theme-picker-toggle"
		type="button"
		class="font-mono text-xs uppercase tracking-wider px-3 py-1.5 border border-border hover:border-accent hover:text-accent transition-colors duration-normal flex items-center gap-2"
		aria-label="Choose theme"
		aria-expanded="false"
		aria-haspopup="true"
	>
		<span id="current-theme-name">Lab</span>
		<span id="current-mode-indicator" class="text-accent">●</span>
		<svg class="w-3 h-3 transition-transform duration-normal" id="dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
		</svg>
	</button>
	
	<div 
		id="theme-picker-dropdown"
		class="absolute right-0 top-full mt-2 min-w-48 bg-surface border-2 border-border hidden z-50"
		role="menu"
	>
		<!-- Theme selection -->
		<div class="border-b border-border">
			<div class="px-3 py-2 text-text-muted font-mono text-xs uppercase tracking-wider">
				Theme
			</div>
			{themes.map((theme) => (
				<button
					type="button"
					class="theme-option w-full text-left px-3 py-2 font-mono text-sm hover:bg-accent-subtle hover:text-accent transition-colors duration-normal flex items-center justify-between"
					data-theme-id={theme.id}
					role="menuitem"
				>
					<span>{theme.name}</span>
					<span class="theme-check text-accent hidden">✓</span>
				</button>
			))}
		</div>
		
		<!-- Mode toggle -->
		<div class="px-3 py-2">
			<div class="text-text-muted font-mono text-xs uppercase tracking-wider mb-2">
				Mode
			</div>
			<div class="flex gap-2">
				<button
					type="button"
					id="mode-dark"
					class="mode-option flex-1 px-3 py-1.5 font-mono text-xs uppercase tracking-wider border border-border hover:border-accent hover:text-accent transition-colors duration-normal"
					data-mode="dark"
					role="menuitem"
				>
					Dark
				</button>
				<button
					type="button"
					id="mode-light"
					class="mode-option flex-1 px-3 py-1.5 font-mono text-xs uppercase tracking-wider border border-border hover:border-accent hover:text-accent transition-colors duration-normal"
					data-mode="light"
					role="menuitem"
				>
					Light
				</button>
			</div>
		</div>
	</div>
</div>

<script define:vars={{ themes, defaultTheme, defaultMode }}>
	// Theme state
	function getStoredTheme() {
		if (typeof localStorage === 'undefined') return defaultTheme;
		return localStorage.getItem('themeId') || defaultTheme;
	}
	
	function getStoredMode() {
		if (typeof localStorage === 'undefined') return defaultMode;
		return localStorage.getItem('themeMode') || defaultMode;
	}
	
	function setTheme(themeId, mode) {
		const themeKey = `${themeId}-${mode}`;
		document.documentElement.setAttribute('data-theme', themeKey);
		localStorage.setItem('themeId', themeId);
		localStorage.setItem('themeMode', mode);
		updateUI(themeId, mode);
	}
	
	function updateUI(themeId, mode) {
		// Update theme name display
		const theme = themes.find(t => t.id === themeId);
		const nameEl = document.getElementById('current-theme-name');
		if (nameEl && theme) {
			nameEl.textContent = theme.name;
		}
		
		// Update mode indicator (filled = dark, hollow = light)
		const indicator = document.getElementById('current-mode-indicator');
		if (indicator) {
			indicator.textContent = mode === 'dark' ? '●' : '○';
		}
		
		// Update theme checkmarks
		document.querySelectorAll('.theme-option').forEach(btn => {
			const check = btn.querySelector('.theme-check');
			if (check) {
				check.classList.toggle('hidden', btn.dataset.themeId !== themeId);
			}
		});
		
		// Update mode buttons
		document.querySelectorAll('.mode-option').forEach(btn => {
			const isActive = btn.dataset.mode === mode;
			btn.classList.toggle('border-accent', isActive);
			btn.classList.toggle('text-accent', isActive);
		});
	}
	
	// Dropdown toggle
	function toggleDropdown(show) {
		const dropdown = document.getElementById('theme-picker-dropdown');
		const arrow = document.getElementById('dropdown-arrow');
		const toggle = document.getElementById('theme-picker-toggle');
		
		if (dropdown && arrow && toggle) {
			const isOpen = show !== undefined ? show : dropdown.classList.contains('hidden');
			dropdown.classList.toggle('hidden', !isOpen);
			arrow.classList.toggle('rotate-180', isOpen);
			toggle.setAttribute('aria-expanded', String(isOpen));
		}
	}
	
	// Initialize
	function init() {
		const themeId = getStoredTheme();
		const mode = getStoredMode();
		setTheme(themeId, mode);
		
		// Toggle button
		document.getElementById('theme-picker-toggle')?.addEventListener('click', (e) => {
			e.stopPropagation();
			toggleDropdown();
		});
		
		// Theme options
		document.querySelectorAll('.theme-option').forEach(btn => {
			btn.addEventListener('click', () => {
				const newThemeId = btn.dataset.themeId;
				const currentMode = getStoredMode();
				setTheme(newThemeId, currentMode);
			});
		});
		
		// Mode options
		document.querySelectorAll('.mode-option').forEach(btn => {
			btn.addEventListener('click', () => {
				const newMode = btn.dataset.mode;
				const currentTheme = getStoredTheme();
				setTheme(currentTheme, newMode);
			});
		});
		
		// Close on outside click
		document.addEventListener('click', (e) => {
			const picker = document.querySelector('.theme-picker');
			if (picker && !picker.contains(e.target)) {
				toggleDropdown(false);
			}
		});
		
		// Close on escape
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				toggleDropdown(false);
			}
		});
	}
	
	init();
	
	// Handle Astro view transitions
	document.addEventListener('astro:after-swap', () => {
		init();
	});
</script>
